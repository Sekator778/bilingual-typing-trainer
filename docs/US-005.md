# US-005: Level Selection (v1.1) — Work Breakdown Structure

## Цель истории

Дать пользователю **управляемый источник слов** (по уровню), чтобы тренировки были осмысленными и повторяемыми, и чтобы дальнейшие функции (mistakes-only, presets) работали на стабильном “корпусе” слов.

---

## P0 — Архитектурные решения (закрепить один раз)

1. **Decision: Pack = текстовый список слов**

  * формат: `one word per line`, lowercase, `^[a-z]+$`
  * хранение: `src/data/packs/*.txt` (в git, детерминированно)

2. **Decision: WordProvider получает `WordSource`**

  * `WordSource` включает `level` и (в будущем) `topic`
  * TrainingScreen не знает, откуда слова — он только спрашивает “дай следующее”.

3. **Decision: fallback**

  * если pack пустой/битый → fallback на маленький встроенный список
  * UX: короткое ненавязчивое сообщение (не модалка)

---

## P1 — Данные: словари уровней (packs)

4. Создать каталог: `src/data/packs/`

5. Добавить файлы (минимальный стартовый набор):

  * `a2.txt`
  * `b1.txt`
  * `b2.txt`
  * `toefl.txt`
  * `tech.txt`

6. Добавить **валидатор packs** (domain util):

  * читает текст pack’а
  * нормализует: trim, lowercase
  * фильтрует: только `^[a-z]+$`
  * удаляет дубликаты
  * если после фильтрации пусто → вернуть ошибку/empty + fallback

> Best practice: pack’и держать маленькими и качественными. Потом расширим.

---

## P2 — Domain: WordProvider v2 (level-aware)

7. Ввести типы:

  * `type Level = 'A2' | 'B1' | 'B2' | 'TOEFL' | 'TECH'`
  * `type WordSource = { level: Level }` (topic позже)

8. Реализовать `WordProvider` как отдельный модуль:

  * `init(source: WordSource): Promise<void> | void`
  * `next(): string`
  * внутри:

    * загрузить pack для уровня
    * подготовить массив слов
    * выбрать стратегию выдачи:

      * MVP: random без повторов до исчерпания (потом shuffle+cursor)
      * при исчерпании: перешафлить и продолжить

9. Интеграция с существующим word list:

  * Сейчас у вас есть 10k как “общий корпус”.
  * Для US-005 источником должен стать **pack**, а не 10k.
  * 10k остаётся как “All/Default” только если захотите отдельный уровень `ALL` (не обязательно).

---

## P3 — Settings: хранение выбора уровня

10. Добавить `levelSettings`:

* key: `typing.level.v1`
* функции:

  * `getSelectedLevel(): Level`
  * `setSelectedLevel(level: Level): void`
* default: `B1` (или `A2`, если ориентир на начинающих)

---

## P4 — UI: Setup screen (или минимальный pre-start)

11. Добавить минимальный экран “Setup”:

* dropdown/select: Level
* кнопка “Start”
* (опционально позже) mode Normal/Mistakes, preset

**Важно:** не засорять TrainingScreen.
TrainingScreen получает уже выбранный `level`.

12. Навигация:

* `/` → Setup
* `/train` → Training
* `/history` → History (уже есть)

---

## P5 — Wiring: TrainingScreen использует WordProvider по выбранному уровню

13. При старте тренировки:

* загрузить выбранный level из settings
* `WordProvider.init({ level })`
* показать первое слово
* Space-to-start overlay остаётся как есть

14. Отобразить текущий уровень в хедере тренировки:

* `Level: B1`
* маленький текст, без лишних элементов

---

## P6 — Тесты (обязательные)

15. Unit tests: pack parsing/validation

* вход: строка с мусором/дубликатами/UPPERCASE
* выход: нормализованный массив
* empty pack → fallback flag/ошибка

16. Unit tests: WordProvider

* при init(A2) использует только слова из A2 pack
* выдача не выходит за пределы набора
* “истощение” списка → повтор с перешафлом (если вы это делаете)

17. UI test: Setup → Training

* выбрать `TECH`
* старт
* убедиться, что показанное слово принадлежит TECH pack (можно через контролируемый тестовый pack)

---

## P7 — Документация

18. `docs/DECISIONS.md`:

* pack формат
* default level
* стратегия выбора слов

19. `docs/TODO.md`:

* отметить US-005 tasks
* добавить follow-up “topics v1.1.1” (не сейчас)

---

# Чёткие deliverables по US-005 (что должно появиться в PR)

* `src/data/packs/*.txt` (минимальный набор)
* `src/domain/packLoader.ts` (или аналог) + тесты
* `src/domain/wordProvider.ts` обновлённый (level-aware) + тесты
* `src/domain/levelSettings.ts`
* `src/SetupScreen.tsx` + route в `App.tsx`
* TrainingScreen показывает активный level и получает слова из WordProvider, а не из 10k.
* Все проверки зелёные: `test:run`, `lint`, `build`

---

# Как это связано с общей архитектурой (чтобы не потерять цель)

* **US-005** делает WordProvider “управляемым” → это база для:

  * **US-006 Mistakes-only** (ошибки по словам внутри уровня)
  * **US-007 Presets** (сессии на конкретном наборе)
  * улучшения переводов (coverage можно оценивать по pack, а не по 10k)
