## US-008: Dictionary refresh (DeepL enrichment pipeline)

### Story

As a maintainer,
I want to refresh/enrich the translations bundle using DeepL,
so that users see translations for (almost) all words and rarely encounter `—`.

### Scope

* Runs **outside the browser runtime** (local script / CI).
* Uses existing base translations (FreeDict intersection) as primary source.
* Uses DeepL only for **missing** translations (gap-filling).
* Updates the shipped bundle (`public/translations.v1.json`), which the app loads read-only.

### Non-functional / Security

* DeepL key is stored in `.env.local` and **never committed**.
* No DeepL calls from the frontend runtime.
* Script is resumable and deterministic (with cache).

### Inputs

* `src/data/raw/google-10000-english.txt` (canonical word list)
* `public/translations.v1.json` (current bundle)
* env:

    * `DEEPL_AUTH_KEY`
    * `DEEPL_API_BASE` (default `https://api-free.deepl.com`)

### Outputs

* Updated `public/translations.v1.json`
* Cache: `tools/cache/deepl-ru-cache.json` (gitignored)
* Coverage report in stdout: before/after counts and percentage

### Acceptance Criteria

* `npm run dict:refresh:ru`:

    * detects missing RU words (from 10k list) that are not translated in bundle
    * batches DeepL requests (safe batch size)
    * writes translations into bundle **without overwriting** existing non-placeholder RU
    * persists cache every batch; reruns reuse cache
    * prints coverage before/after
* If no key is provided: fails fast with clear message, no bundle corruption.
* If API call fails mid-run:

    * script exits non-zero
    * already cached results remain on disk
    * bundle remains valid JSON (either unchanged or updated only after successful batch write—выберите подход и зафиксируйте)
* Tests:

    * shape validation for bundle
    * merge precedence (FreeDict/base > DeepL only fills missing)
    * cache usage behavior (no repeated calls for cached words)

### Definition of Done

* Script exists and documented (`docs/OPERATIONS.md`).
* `.env.local` and cache paths are in `.gitignore`.
* Running:

    * `npm run build:ru` then `npm run dict:refresh:ru`
    * leads to increased RU coverage in bundle
* App shows improved translation coverage without runtime API calls.

---

# Разбиение на реализацию (пункты)

## P0 — Документы и ключи

1. Добавить в `.gitignore`:

    * `.env.local`
    * `tools/cache/`
2. Создать `docs/OPERATIONS.md` с разделом “Dictionary refresh (RU)”.

## P1 — Скрипт refresh

3. `scripts/dict-refresh-ru.mjs`

    * load `.env.local` (или использовать dotenv dependency — на ваш выбор)
    * read 10k list
    * load bundle
    * compute missing RU keys
    * DeepL batch translate
    * update cache + bundle
    * print coverage

## P2 — NPM scripts

4. `package.json`:

    * `dict:refresh:ru`: `node scripts/dict-refresh-ru.mjs`

## P3 — Тесты

5. `src/domain/` или `scripts/` tests:

    * validate bundle schema (version/langs/data)
    * test merge precedence: existing RU is not overwritten
    * test cache hit path (mock DeepL client)

## P4 — CI hook (опционально)

6. (опционально) gitlab/github workflow step:

    * run refresh only when maintainer triggers (manual), because it consumes DeepL quota.

---

## Важная фиксация решения (1 строка в DECISIONS.md)

* “DeepL enrichment is an **offline build/ops step**; browser runtime never calls DeepL.”
