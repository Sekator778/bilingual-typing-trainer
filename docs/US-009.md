# US-009: Export / Import Progress (Local-First Portability)

## Goal of the Story

To allow users to **transfer or save their progress** without accounts or a backend, so that:

* they don't lose history and errors,
* they can move to another device,
* they can feel the tool is reliable.

This **increases trust in the product**, not just adds a "feature."

---

## P0 — Architectural Decisions (must be documented)

1. **Local-first, no backend**

* Export/import is a **JSON file**.
* No API, no authorization.

2. **Single snapshot**

* Export is an **atomic snapshot**:

* settings
* history (sessions)
* mistakes store
* Not three separate files.

3. **Schema-versioned**

* Exported JSON has a `schemaVersion`. * This will protect against future format changes.

---

## P1 — Exported file format (contract)

### Export file: `typing-trainer-export.json`

```json
{ 
"schemaVersion": 1, 
"exportedAt": "2025-01-14T12:00:00.000Z", 
"appVersion": "0.1.0", 
"data": { 
"settings": { 
"level": "B1", 
"mode": "mistakes", 
"preset": { "kind": "byWords", "targetWords": 25 }, 
"translationLang": "ru", 
"autoAdvance": true, 
"autoSpeak": false 
}, 
"history": [ /* SessionRecord[] */ ], 
"mistakes": { 
"packing": { "mistakes": 3, "lastMistakeAt": 1700000000000 }
}
}
}
```

### Acceptance Criteria

* All key domain data is present.
* No transient/runtime fields.
* Human-readable JSON (pretty-printed).

---

## P2 — Domain: Export builder

4. Create `src/domain/exportSnapshot.ts`

API:

```ts
export function buildExportSnapshot(): ExportSnapshot;
```

Responsibilities:

* Collect data from:

* `levelSettings`
* `modeSettings`
* `presetSettings`
* `translationSettings`
* `sessionStore`
* `mistakesStore`
* Add metadata (`schemaVersion`, `exportedAt`, `appVersion`)

### Acceptance Criteria

* Snapshot is deterministic when the state is the same
* Snapshot is valid according to the schema

---

## P3 — Domain: Import validator + applier

5. Create `src/domain/importSnapshot.ts`

API:

```ts
export function validateImportSnapshot(json: unknown): ImportResult;
export function applyImportSnapshot(snapshot: ExportSnapshot): void;
```

### Validation rules

* Check `schemaVersion`
* Check key field types
* Reject:

* Unknown version
* Broken JSON
* Missing required sections

### Apply rules (important)

* **Settings** → overwrite
* **History** → merge:

* default: replace entirely (MVP, simpler and safer)
* **Mistakes** → merge:

* if the word exists → `mistakes = max(existing, imported)`
* `lastMistakeAt = max(...)`

(This is a best practice: don't lose the "worse" state.)

---

## P4 — UI: Export / Import entry point

6. Add to UI (best — **History screen** or **Settings panel**):

* Button: **Export progress**
* Button: **Import progress**

7. Export flow:

* Click → `buildExportSnapshot`
* Download file (`URL.createObjectURL + <a download>`)

8. Import flow:

* File picker (`accept: application/json`)
* Parse → validate
* If invalid:

* show inline error (not alert)
  *If valid:

*apply snapshot
* show success message
* redirect to History or Setup

---

## P5 - UX requirements (important)

9. Import - **obviously destructive**

* Text:

> “Import will overwrite your current progress. Continue?”
* Confirmation required.

10. No modal spam

* One confirmation
* One success/error message

---

## P6 — Tests (required)

11. Unit tests:

* `buildExportSnapshot`:

* contains all required sections
* `validateImportSnapshot`:

* rejects invalid schema
* accepts valid snapshot
* `applyImportSnapshot`:

* settings overwrite
* mistakes merge logic
* history replace

12. UI tests:

* Export button produces downloadable blob
* Import invalid file → error message
* Import valid file → state updated

---

## P7 — Docs

13. `docs/OPERATIONS.md`

* short section:

> “User-level backup & restore (Export / Import)”

14. `docs/DECISIONS.md`

* Merge strategy (especially for errors)

15. `docs/USER_STORIES.md`

* Add US-009 as implemented/implemented

---

## Definition of Done (US-009)

* User can export progress to a file.
* User can import a file and restore progress.
* Errors and history are correctly restored.
* No backend/API.
* All tests are green.