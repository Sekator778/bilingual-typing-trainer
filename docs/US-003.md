Принято. По описанию ты сделал именно те правки, которые ожидаемы в зрелом Web-first проекте (устойчивые test anchors, корректные зависимости хуков, корректный typing конфиг для vitest). Можно двигаться дальше.

Ниже — **US-003 в dev-ready формате**, строго в рамках нашего дизайна: local-first, no backend, zero-distraction, не ломаем US-001/US-002.

---

## US-003: Typing statistics (Dev-ready)

### Story

As a user,
I want to see my typing speed and accuracy,
so that I can track my progress over time.

### Scope

* Statistics are computed for **single-word training sessions** (US-001 flow).
* Persist session results locally (no backend, no accounts).
* MVP stores:

  * session timestamp
  * duration
  * WPM
  * accuracy
  * words attempted / words completed
  * total chars typed / correct chars / errors (optional but useful)
* A minimal “History” view is included.

### UX / UI Specification

#### On Training screen (real-time)

* Show a small, non-distracting stats strip (e.g., top-right or below input):

  * **WPM** (current session)
  * **Accuracy %**
  * **Words**: `completed / total` (or `completed` only if total not defined)
* Stats update in real-time, but must not cause lag while typing.

#### History view

* A simple list view with last N sessions (e.g., 50):

  * Date/time
  * Duration
  * Avg WPM
  * Accuracy
  * Words completed
* Navigation must be minimal:

  * either a small “History” button/link,
  * or a settings menu entry.
* No charts required in MVP.

### Definitions & calculation rules

#### Session lifecycle

* Session starts when:

  * user enters Training screen **and**
  * the first word is shown (or first keypress; pick one and keep consistent).
* Session ends when:

  * user leaves the Training screen, or
  * user hits a “Finish” button (optional), or
  * session reaches a fixed target (e.g., N words).
    **MVP recommendation:** session ends when user leaves screen; store snapshot on unmount.

#### WPM (Words Per Minute)

* Use standard definition:

  * `grossWpm = (typedChars / 5) / minutesElapsed`
* `typedChars` counts all typed characters (including incorrect) **excluding backspaces** (recommended), because backspace counting is implementation-specific.
* If `minutesElapsed < 0.1` (first seconds), WPM can be 0 or still computed but clamped.

#### Accuracy

* `accuracy = correctChars / typedChars` (0–1), displayed as percentage.
* `correctChars` increments when a typed character matches the target character at that position at the time of input.
* `typedChars` increments on each letter input (a–z) accepted by TypingEngine.

#### Errors

* `errors` increments when a typed character is incorrect at the position (at time of input).
* If user corrects later via backspace, the historical error still counts (recommended for learning metrics).
  (Alternative approach: recompute accuracy from final word; but that hides mistakes. We choose “count mistakes as they happen”.)

### Persistence (local-first)

* Store session results locally in:

  * IndexedDB preferred, or
  * localStorage for MVP if kept small.
* Store config separately (already exists from US-002).

### Error handling / resilience

* If storage is unavailable (quota, denied, private mode quirks):

  * app continues working,
  * shows subtle “History unavailable” message in History view,
  * no crashes.

### Acceptance Criteria

* Training screen shows WPM and accuracy that update during typing.
* WPM and accuracy values are consistent with the definitions above.
* At least one completed session is saved locally and appears in History view.
* History view lists multiple past sessions with correct primary metrics.
* Clearing local storage does not crash the app; history becomes empty gracefully.
* Stats implementation does not introduce noticeable input lag.

### Out of scope (explicit)

* User accounts / cloud sync / PostgreSQL backend.
* Detailed per-word analytics (reserved for US-006 / v1.1).
* Charts and dashboards.

### Definition of Done

* `StatsModule` (or equivalent) exists as a domain module (not UI-only counters).
* Unit tests cover:

  * WPM calculation (known chars + known time → expected WPM),
  * accuracy calculation (correct/typed counts),
  * session serialization format (stored object shape).
* A minimal History UI test verifies:

  * rendering empty state,
  * rendering one stored session.

### Technical Notes (MVP)

* Stats collection must be driven by TypingEngine events:

  * `onCharTyped(correct: boolean)` updates counters without recalculating the whole state.
* Avoid re-rendering large parts of UI on each keystroke:

  * store “fast counters” in refs and update displayed values at a controlled cadence if needed (optional optimization),
  * or keep state updates minimal.

---

## Рекомендуемое разбиение на задачи (для TODO.md)

**US-003**

1. `StatsModule` (domain): counters + `snapshot()` + `wpm()` + `accuracy()`
2. Wiring: TrainingScreen sends events (typed char + correct/incorrect) into StatsModule
3. Persist sessions: `SessionStore` (localStorage/IndexedDB) + “append session on end”
4. History view: route/screen + list + empty state
5. Tests:

  * stats unit tests
  * history UI smoke test

---

Если устраивает такой контракт, следующий шаг сделаю максимально прикладным:
дам **референсную модель данных** (`SessionRecord`), предложу **storage выбор** (для MVP я бы начал с localStorage, но могу дать IndexedDB сразу), и напишу “скелет” `StatsModule` с тестами, чтобы ты просто интегрировал в TrainingScreen.
