# US-006: Practice Mistakes Only (v1.1) — Work Breakdown Structure

## Цель истории

Дать пользователю режим тренировки, который подбирает слова **только из тех**, где он ранее ошибался, чтобы замыкать learning loop и ускорять прогресс.

---

## P0 — Решения и определения (зафиксировать в DECISIONS.md)

1. **Что считаем “ошибкой” на слово**

    * Вариант A (рекомендую для MVP): `wordMistakeCount += incorrectChars` за попытку слова.
    * Вариант B: `wordMistakeCount += 1` если слово было завершено не с первого раза / были ошибки.
    * Выберите A или B и зафиксируйте (иначе статистика будет “плавать”).

2. **Когда фиксируем статистику по слову**

    * На “commit” слова (в вашей логике это момент “слово набрано верно + Enter”).
    * До commit ошибки в MistakesStore не записываем (иначе будет шум).

3. **Как MistakesStore взаимодействует с levels**

    * Для MVP: хранить ошибки **по слову независимо от уровня**, но при “Mistakes only” фильтровать по текущему Level pack (важно).
    * Это даёт корректный UX: выбрал B1 → повторяешь ошибки из B1.

---

## P1 — Data model: MistakesStore (domain)

4. Создать `src/domain/mistakesStore.ts`

Модель:

```ts
export type WordMistakeStats = {
  mistakes: number;       // aggregated
  attempts: number;       // optional, useful later
  lastMistakeAt?: number;
  lastSeenAt?: number;
};

export type MistakesMap = Record<string, WordMistakeStats>;
```

API:

* `loadMistakes(): MistakesMap`
* `saveMistakes(map: MistakesMap): void`
* `recordWordResult(word: string, errors: number): void`
* `getMistakesForWords(words: string[]): Array<{word, stats}>`

Storage key:

* `typing.mistakes.v1`

Constraints:

* defensive: если localStorage недоступен → работать без падения (как делали для History).

---

## P2 — Wiring: capture per-word errors

5. Определить, откуда брать `errors` по текущему слову

    * У вас уже есть подсветка ошибок и расчёт accuracy/WPM.
    * Нужно иметь **переменную счётчика ошибок на слово**:

        * `wordErrors` — увеличивается при вводе неверного символа (в strict/forgiving зависит от вашей текущей логики).
    * На commit слова: вызвать `recordWordResult(currentWord, wordErrors)`.

6. Поддержать “no mistake” path

    * если `wordErrors === 0`:

        * `attempts++`, `lastSeenAt = now`, но `mistakes` не растёт.

---

## P3 — Selection algorithm: MistakesWordProvider

7. Добавить стратегию подбора слов “mistakes only” в WordProvider (или отдельным провайдером)

Рекомендуемая структура:

* `WordProvider` остаётся основной точкой,
* но получает `mode`:

```ts
type TrainingMode = 'normal' | 'mistakes';
type WordSource = { level: Level; mode: TrainingMode };
```

Алгоритм MVP:

* взять слова из текущего level pack (у вас US-005)
* отфильтровать по `mistakes > 0`
* отсортировать: `mistakes desc`, затем `lastMistakeAt desc`
* выдавать по порядку, при исчерпании — повторять с тем же порядком или с лёгким shuffle среди топа.

Если список пуст:

* режим “mistakes” недоступен → показать сообщение и вернуться в setup.

---

## P4 — UI: Setup screen mode toggle

8. В `SetupScreen` добавить выбор режима:

* `Normal`
* `Mistakes only`

UX требования:

* минималистично, без лишнего.
* рядом с Level.

9. Поведение кнопки Start:

* если Mode=mistakes:

    * проверить, что для выбранного уровня есть хотя бы 1 слово с mistakes
    * если нет → показать inline message:

        * “No mistakes recorded yet. Start a normal session first.”

---

## P5 — Training screen indicators (минимум)

10. В хедере тренировки показать:

* `Mode: Mistakes` (если выбран)
* `Level: B1` (как в US-005)

Без дополнительных панелей.

---

## P6 — Tests (обязательные)

11. Unit tests: `mistakesStore`

* recordWordResult increments as per выбранной метрики (A/B)
* persists/load roundtrip
* storage unavailable → no crash (мок localStorage)

12. Unit tests: mistakes selection

* given pack words + mistakes map → returns expected ordered list
* empty mistakes list → returns empty + signal

13. UI test: Setup “Mistakes only”

* при пустом mistakes store показывает message и не стартует
* при заполненном store стартует и Training word принадлежит mistakes set

---

## P7 — Docs

14. `docs/DECISIONS.md`:

* метрика ошибки (A/B)
* фильтрация mistakes по текущему Level pack

15. `docs/TODO.md`:

* checklist под US-006

---

# Deliverables (что должно быть в PR)

* `src/domain/mistakesStore.ts` + tests
* обновление TypingEngine/TrainingScreen для учёта `wordErrors` и записи результата на commit
* обновление WordProvider под mode=mistakes
* обновление SetupScreen (mode toggle + empty-state)
* тесты зелёные: `npm run test:run`, `npm run lint`, `npm run build`

---

# Важное уточнение (одно, чтобы не “плыть”)

Перед тем как вы начнёте кодить: выберите метрику ошибок для слова:

**A)** накапливаем количество неверных символов (`mistakes += incorrectChars`)
**B)** накапливаем факт ошибки за слово (`mistakes += 1 if errors>0`)

Если вы не хотите обсуждать — берите **B** (проще и стабильнее). Для будущей аналитики можно добавить `incorrectCharsTotal`.

Скажите “A” или “B”, и вы можете начинать реализацию без дальнейших уточнений.
